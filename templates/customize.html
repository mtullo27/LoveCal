{% extends "layout.html" %}
{% block title %}Customize Interface{% endblock %}
{% block content %}
<div class="container">
  <h1 class="text-2xl font-bold mb-6">Customize Interface</h1>
  <form id="customForm" method="post" class="space-y-6">
    <!-- Calendar Entries -->
    <div>
      <label class="block mb-2 text-sm font-medium text-gray-900">Calendar Entries</label>
      <div id="calendarsContainer">
        {% for entry in calendar_entries %}
        <div class="calendar-entry flex items-center space-x-2 mb-2">
          <input type="text" name="calendar_urls" value="{{ entry.url }}" placeholder="Calendar URL"
            class="calendar-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block flex-grow p-2.5">
          <input type="color" name="calendar_colors" value="{{ entry.color }}"
            class="calendar-input w-10 h-10 p-0 border-0">
          <button type="button" class="delete-calendar" onclick="deleteCalendar(this)"
            {% if calendar_entries|length == 1 %} style="display:none;" {% endif %}>
            <i class="bi bi-dash-circle" style="color: {{ button_color }};"></i>
          </button>
          <button type="button" class="add-calendar" onclick="addCalendar(this)">
            <i class="bi bi-plus-circle" style="color: {{ button_color }};"></i>
          </button>
        </div>
        {% endfor %}
      </div>
    </div>
    <!-- A different button that also triggers auto-submit -->
    <div>
      <button type="button" id="otherAction" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
        Other Action
      </button>
    </div>
    <!-- Optional manual submission button -->
    <div>
      <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Save Changes
      </button>
    </div>
  </form>
</div>

<script>
  // Submits the form.
  function autoSubmit() {
    document.getElementById('customForm').submit();
  }

  // Setup auto-submit behavior for a single input element.
  function setupAutoSubmitForInput(input) {
    let idleTimer;
    // When the user types, reset a 10-second timer.
    input.addEventListener('input', function() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(autoSubmit, 10000); // 10 seconds idle
    });
    // When the user leaves the input, immediately submit.
    input.addEventListener('blur', function() {
      clearTimeout(idleTimer);
      autoSubmit();
    });
  }

  // Attach auto-submit events to all calendar inputs.
  function setupAutoSubmitForCalendarEntries() {
    const calendarInputs = document.querySelectorAll('.calendar-input');
    calendarInputs.forEach(input => {
      setupAutoSubmitForInput(input);
    });
  }

  // Adds a new calendar entry row and sets up auto-submit for its inputs.
  function addCalendar(button) {
    const container = document.getElementById('calendarsContainer');
    const newDiv = document.createElement('div');
    newDiv.className = 'calendar-entry flex items-center space-x-2 mb-2';
    newDiv.innerHTML = `
      <input type="text" name="calendar_urls" placeholder="Calendar URL"
        class="calendar-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block flex-grow p-2.5">
      <input type="color" name="calendar_colors" value="#007aff"
        class="calendar-input w-10 h-10 p-0 border-0">
      <button type="button" class="delete-calendar" onclick="deleteCalendar(this)">
        <i class="bi bi-dash-circle" style="color: {{ button_color }};"></i>
      </button>
      <button type="button" class="add-calendar" onclick="addCalendar(this)">
        <i class="bi bi-plus-circle" style="color: {{ button_color }};"></i>
      </button>
    `;
    container.appendChild(newDiv);
    // Setup auto-submit for the new inputs.
    setupAutoSubmitForCalendarEntries();
  }

  // Deletes a calendar entry row and auto-submits the form.
  function deleteCalendar(button) {
    const entryRow = button.closest('.calendar-entry');
    entryRow.remove();
    autoSubmit();
  }

  // When the page is loaded, attach auto-submit to calendar inputs
  // and also attach a click event to the "Other Action" button.
  document.addEventListener('DOMContentLoaded', function() {
    setupAutoSubmitForCalendarEntries();

    document.getElementById('otherAction').addEventListener('click', function() {
      autoSubmit();
    });
  });
</script>
{% endblock %}
